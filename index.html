
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://fugue-project.github.io/prefect-fugue/">
      
      <link rel="icon" href="img/favicon.ico">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.2">
    
    
      
        <title>prefect-fugue</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prefect-fugue-integration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="prefect-fugue" class="md-header__button md-logo" aria-label="prefect-fugue" data-md-component="logo">
      
  <img src="img/prefect-logo-white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            prefect-fugue
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/fugue-project/prefect-fugue" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="prefect-fugue" class="md-nav__button md-logo" aria-label="prefect-fugue" data-md-component="logo">
      
  <img src="img/prefect-logo-white.png" alt="logo">

    </a>
    prefect-fugue
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/fugue-project/prefect-fugue" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Home
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        Home
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting Started
  </a>
  
    <nav class="md-nav" aria-label="Getting Started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-setup" class="md-nav__link">
    Python setup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-block" class="md-nav__link">
    Creating a Block
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-spark-cluster-inside-a-flow" class="md-nav__link">
    Using a Spark Cluster Inside a Flow
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-locally-before-running-map-jobs-on-spark-dask-and-ray" class="md-nav__link">
    Testing Locally Before Running Map Jobs on Spark, Dask, and Ray
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-sql-on-any-spark-dask-and-duckdb" class="md-nav__link">
    Running SQL on any Spark, Dask, and Duckdb
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    Resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development" class="md-nav__link">
    Development
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="tasks/" class="md-nav__link">
        Tasks
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="blocks/" class="md-nav__link">
        Blocks
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="context/" class="md-nav__link">
        Context
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting Started
  </a>
  
    <nav class="md-nav" aria-label="Getting Started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-setup" class="md-nav__link">
    Python setup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-block" class="md-nav__link">
    Creating a Block
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-spark-cluster-inside-a-flow" class="md-nav__link">
    Using a Spark Cluster Inside a Flow
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-locally-before-running-map-jobs-on-spark-dask-and-ray" class="md-nav__link">
    Testing Locally Before Running Map Jobs on Spark, Dask, and Ray
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-sql-on-any-spark-dask-and-duckdb" class="md-nav__link">
    Running SQL on any Spark, Dask, and Duckdb
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    Resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development" class="md-nav__link">
    Development
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/edit/main/docs/README.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="prefect-fugue-integration">Prefect Fugue Integration</h1>
<p><a href="https://GitHub.com/fugue-project/prefect-fugue"><img alt="GitHub release" src="https://img.shields.io/github/release/fugue-project/prefect-fugue.svg" /></a>
<a href="https://pypi.python.org/pypi/prefect-fugue/"><img alt="PyPI pyversions" src="https://img.shields.io/pypi/pyversions/prefect-fugue.svg" /></a>
<a href="https://pypi.python.org/pypi/prefect-fugue/"><img alt="PyPI license" src="https://img.shields.io/pypi/l/prefect-fugue.svg" /></a>
<a href="https://pypi.python.org/pypi/prefect-fugue/"><img alt="PyPI version" src="https://badge.fury.io/py/prefect-fugue.svg" /></a>
<a href="https://codecov.io/gh/fugue-project/prefect-fugue"><img alt="codecov" src="https://codecov.io/gh/fugue-project/prefect-fugue/branch/master/graph/badge.svg?token=J4UB06GWO1" /></a>
<a href="https://prefect-fugue.readthedocs.org"><img alt="Doc" src="https://readthedocs.org/projects/prefect-fugue/badge" /></a></p>
<p><a href="http://slack.fugue.ai"><img alt="Slack Status" src="https://img.shields.io/badge/slack-join_chat-white.svg?logo=slack&amp;style=social" /></a></p>
<p>This project provides the Fugue tasks, context and blocks for Prefect.</p>
<h2 id="getting-started">Getting Started</h2>
<p>Fugue is a unified interface for distributed computing that lets users execute Python, pandas, and SQL code on Spark, Dask and Ray without rewrites.</p>
<p>The most common use cases are:</p>
<ul>
<li>Accelerating or scaling existing Python and pandas code by bringing it to Spark or Dask with minimal rewrites.
Using FugueSQL to define end-to-end workflows on top of pandas, Spark, and Dask DataFrames. FugueSQL is an enhanced SQL interface that can invoke Python code with added keywords.</li>
<li>Maintaining one codebase for pandas, Spark, Dask and Ray projects. Logic and execution are decoupled through Fugue, enabling users to be focused on their business logic rather than writing framework-specific code.</li>
<li>Improving iteration speed of big data projects. Fugue seamlessly scales execution to big data after local development and testing. By removing PySpark code, unit tests can be written in Python or pandas and ran locally without spinning up a cluster.</li>
</ul>
<p><img alt="img" src="docs/img/fugue.png" /></p>
<p>The best way to get started with Fugue is to work through the 10 minute tutorials:</p>
<ul>
<li><a href="https://fugue-tutorials.readthedocs.io/tutorials/quick_look/ten_minutes.html">Fugue in 10 minutes</a></li>
<li><a href="https://fugue-tutorials.readthedocs.io/tutorials/quick_look/ten_minutes_sql.html">FugueSQL in 10 minutes</a></li>
</ul>
<h3 id="python-setup">Python setup</h3>
<p>Requires an installation of Python 3.7+.</p>
<p>We recommend using a Python virtual environment manager such as pipenv, conda or virtualenv.</p>
<p>These tasks are designed to work with Prefect 2.0. For more information about how to use Prefect, please refer to the <a href="https://orion-docs.prefect.io/">Prefect documentation</a>.</p>
<h3 id="installation">Installation</h3>
<p>Install <code>prefect-fugue</code> with <code>pip</code>:</p>
<div class="highlight"><pre><span></span><code>pip install prefect-fugue
</code></pre></div>
<p>It's also recommended to register Fugue blocks into your current Prefect workspace:</p>
<div class="highlight"><pre><span></span><code>prefect block register -m prefect_fugue
</code></pre></div>
<h3 id="creating-a-block">Creating a Block</h3>
<p>This will allow a creation of the Fugue Engine block</p>
<p><img alt="img" src="https://fugue-tutorials.readthedocs.io/_images/prefect_fugue_block.png" /></p>
<p>There are 4 items that need to be filled to create a block.</p>
<ul>
<li>Block Name - name that will be used to use the block.</li>
<li>Engine Name - one of the Fugue supported backends (spark, dask, ray, duckdb)</li>
<li>Engine Config - configurations related to the cluster</li>
<li>Secret Config - credentials to connect to a cluster</li>
</ul>
<p>For example, a Databricks Block could look like:</p>
<ul>
<li>Block Name - databricks</li>
<li>Engine Name - spark</li>
<li>Engine Config - None</li>
<li>Secret Config - seen below</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://dbc-38aaa459-faaf.cloud.databricks.com&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dapiecaaae64a727498daaaaafe1bace968a&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;cluster_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0612-191111-6fopaaaa&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="using-a-spark-cluster-inside-a-flow">Using a Spark Cluster Inside a Flow</h3>
<p>Let’s start by running code on top of Databricks. <code>databricks-connect</code> is already installed in this environment. This section may have a lot of logs because of the monitoring provided by Prefect. This section also assumes that the user has Prefect configured to the right workspace.</p>
<p>Below we have one task that takes in a <code>SparkSession</code> and uses it to run some Spark code. We can then use this in the Prefect Flow with the <code>fugue_engine</code> context. This <code>fugue_engine</code> will create an ephemeral cluster to run the code underneath, and then turn off when finished.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">prefect</span> <span class="kn">import</span> <span class="n">task</span><span class="p">,</span> <span class="n">flow</span>
<span class="kn">from</span> <span class="nn">prefect_fugue</span> <span class="kn">import</span> <span class="n">fugue_engine</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">my_spark_task</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([[</span><span class="sa">f</span><span class="s2">&quot;hello spark </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]],</span> <span class="s2">&quot;a string&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nd">@flow</span>
<span class="k">def</span> <span class="nf">native_spark_flow</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">fugue_engine</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">engine</span><span class="p">:</span>
        <span class="n">my_spark_task</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">spark_session</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">native_spark_flow</span><span class="p">(</span><span class="s2">&quot;fugue/databricks&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Similarly, if you don’t use Databricks but have your own way to get a <code>SparkSession</code>, you can directly pass the <code>SparkSession</code> into the Flow. The <code>fugue_engine</code> context will be able to interpret this.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>

<span class="n">native_spark_flow</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
</code></pre></div>
<h2 id="testing-locally-before-running-map-jobs-on-spark-dask-and-ray">Testing Locally Before Running Map Jobs on Spark, Dask, and Ray</h2>
<p>We showed how to run Spark code on top of a Spark cluster, but the strength of Fugue is decoupling from distributed framework code such as Spark and Dask. Decoupling from these frameworks allows us to test code locally before scaling out to a cluster. In the example below, we simulate having a pandas DataFrame where each row is a job.</p>
<p>When testing the Flow, we can pass <code>None</code> as the engine so everything runs on Pandas. When ready to scale out, we can pass in our <code>Block</code> or <code>SparkSession</code>. Fugue’s <code>transform()</code> task will use the engine provided by the <code>fugue_engine</code> context.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">prefect_fugue</span> <span class="kn">import</span> <span class="n">transform</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">create_jobs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">jobs</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>

<span class="c1"># schema: *,batch_size:str</span>
<span class="k">def</span> <span class="nf">run_one_job</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">sleep</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

<span class="nd">@flow</span>
<span class="k">def</span> <span class="nf">run_all_jobs</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="n">create_jobs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">fugue_engine</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">transform</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">run_one_job</span><span class="p">,</span> <span class="n">partition</span><span class="o">=</span><span class="s2">&quot;per_row&quot;</span><span class="p">,</span> <span class="n">as_local</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>We can test the Flow above on a local machine without Spark. We run on one job first.</p>
<div class="highlight"><pre><span></span><code><span class="n">run_all_jobs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># run locally on Pandas</span>
</code></pre></div>
<p>Becasue it succeeded, we can now attach our Fugue Databricks <code>Block</code> to run on Databricks. Now we run on 8 jobs, and we’ll see that parallelization from the Spark cluster will make this Flow execute faster.</p>
<div class="highlight"><pre><span></span><code><span class="n">run_all_jobs</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;fugue/databricks&quot;</span><span class="p">)</span> <span class="c1"># run on databricks</span>
</code></pre></div>
<p>There is still some overhead with sending the work, but the time is decreased compared to the expected execution time if ran sequentially (40 seconds).</p>
<p>We can also use local Dask by passing the string <code>"dask"</code>. We can also pass a <code>Dask Client()</code> or use the Fugue Engine <code>Block</code> with <a href="https://coiled.io/">Coiled</a>. More information can be found in the <a href="https://fugue-tutorials.readthedocs.io/tutorials/integrations/cloudproviders/coiled.html">Coiled cloudprovider docs</a>.</p>
<div class="highlight"><pre><span></span><code><span class="n">run_all_jobs</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;dask&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="running-sql-on-any-spark-dask-and-duckdb">Running SQL on any Spark, Dask, and Duckdb</h2>
<p>Prototyping locally, and then running the full job on the cluster is also possible with <a href="https://fugue-tutorials.readthedocs.io/tutorials/quick_look/ten_minutes_sql.html">FugueSQL</a>. DuckDB is a good engine to run SQL queries on flat files or Pandas DataFrames. When ready, we can bring it to SparkSQL on the cluster. Similar to the transform() task shown above, there is also an fsql() task.</p>
<p>Here we can load in data and perform a query with FugueSQL. FugueSQL has additional keywords such as LOAD and SAVE so we can run everything from loading, processing, and saving all on DuckDB or SparkSQL. More information on FugueSQL can be found in the FugueSQL tutorials.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@flow</span>
<span class="k">def</span> <span class="nf">run_sql_full</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">fugue_engine</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
        <span class="n">fsql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        df = LOAD &quot;https://d37ci6vzurychx.cloudfront.net/trip-data/green_tripdata_2022-01.parquet&quot;</span>

<span class="s2">        SELECT PULocationID, COUNT(*) AS ct FROM df</span>
<span class="s2">        GROUP BY 1 ORDER BY 2 DESC LIMIT {{top}}</span>
<span class="s2">        PRINT</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top</span><span class="p">)</span>
</code></pre></div>
<p>To debug locally without SparkSQL, we can use DuckDB as the engine.</p>
<div class="highlight"><pre><span></span><code><span class="n">run_sql</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;duckdb&quot;</span><span class="p">);</span> <span class="c1"># debug/develop without spark</span>
</code></pre></div>
<p>Again to run on the cluster, we can use the Databricks Block.</p>
<div class="highlight"><pre><span></span><code><span class="n">run_sql</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;fugue/databricks&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="resources">Resources</h2>
<p>If you encounter any bugs while using <code>prefect-fugue</code>, feel free to open an issue in the <a href="https://github.com/fugue-project/prefect-fugue">prefect-fugue</a> repository.</p>
<p>If you have any questions or issues while using <code>prefect-fugue</code>, you can find help in the <a href="http://slack.fugue.ai">Fugue Slack community</a>.</p>
<h2 id="development">Development</h2>
<p>If you'd like to install a version of <code>prefect-fugue</code> for development, clone the repository and perform an editable install with <code>pip</code>:</p>
<div class="highlight"><pre><span></span><code>git clone https://github.com/fugue-project/prefect-fugue.git

<span class="nb">cd</span> prefect-fugue/

pip install -e <span class="s2">&quot;.[dev]&quot;</span>

<span class="c1"># Install linting pre-commit hooks</span>
pre-commit install
</code></pre></div>




              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
      
        
        <a href="tasks/" class="md-footer__link md-footer__link--next" aria-label="Next: Tasks" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Tasks
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "search": "assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
    
  </body>
</html>